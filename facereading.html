<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ëª…ì„ ëŒ€ë¹„í•˜ì</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9807035669654635" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .custom-btn {
            padding: 12px 20px;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .btn-primary:disabled {
            background-color: #374151;
            cursor: not-allowed;
        }
        .btn-secondary {
            border: 2px solid #4a5568;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4a5568;
        }
        input[type="file"] {
            display: none;
        }
        .input-field {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: white;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        select.input-field {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .image-container p {
            max-width: 90%;
        }
        .result-box {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 100px;
            white-space: pre-wrap;
            color: #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen p-4 pt-16">

    <div class="w-full bg-gray-900/80 backdrop-blur-sm text-white text-sm text-center py-2 fixed top-0 left-0 z-50 border-b border-gray-700">
        <p>ğŸ”® ëˆ„ì  ë°©ë¬¸ììˆ˜: <span id="visitor-count" class="font-bold">...</span></p>
    </div>

    <div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-3 text-white">ìš´ëª…ì„ ëŒ€ë¹„í•˜ì</h1>
            <p class="text-gray-400">ê´€ìƒê³¼ ì‚¬ì£¼ ì •ë³´ë¡œ ë§¤ì¼ í•˜ë£¨ë¥¼ ì´ê²¨ë‚´ìš”.</p>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ ì…ë ¥ë€ -->
        <div class="space-y-4 mb-6 bg-gray-900/50 p-4 rounded-lg">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="lg:col-span-2">
                    <label for="birthdate" class="block text-sm font-medium text-gray-300 mb-1">ìƒë…„ì›”ì¼</label>
                    <div class="flex items-center gap-4">
                        <input type="date" id="birthdate" class="input-field" value="1990-01-01">
                        <div class="flex items-center space-x-4 flex-shrink-0">
                            <label class="flex items-center text-gray-300 cursor-pointer">
                                <input type="radio" name="calendarType" value="solar" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                                <span class="ml-2">ì–‘ë ¥</span>
                            </label>
                            <label class="flex items-center text-gray-300 cursor-pointer">
                                <input type="radio" name="calendarType" value="lunar" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                                <span class="ml-2">ìŒë ¥</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="birthtime" class="block text-sm font-medium text-gray-300 mb-1">íƒœì–´ë‚œ ì‹œê°„</label>
                    <input type="time" id="birthtime" class="input-field" value="07:00">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4 border-t border-gray-700">
                 <div>
                    <label for="gender" class="block text-sm font-medium text-gray-300 mb-1">ì„±ë³„</label>
                     <div class="flex items-center space-x-4 h-full">
                        <label for="male" class="flex items-center text-gray-300 cursor-pointer">
                            <input type="radio" id="male" name="gender" value="male" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                            <span class="ml-2">ë‚¨ì„±</span>
                        </label>
                        <label for="female" class="flex items-center text-gray-300 cursor-pointer">
                            <input type="radio" id="female" name="gender" value="female" class="w-4 h-4 text-pink-600 bg-gray-700 border-gray-600 focus:ring-pink-500">
                                <span class="ml-2">ì—¬ì„±</span>
                            </label>
                        </div>
                    </div>
                 <div>
                    <label for="birthRegion" class="block text-sm font-medium text-gray-300 mb-1">ì¶œìƒì§€ì—­</label>
                    <select id="birthRegion" class="input-field">
                        <option>ì„œìš¸</option><option>ë¶€ì‚°</option><option>ëŒ€êµ¬</option><option>ì¸ì²œ</option><option>ê´‘ì£¼</option><option>ëŒ€ì „</option><option>ìš¸ì‚°</option><option>ì„¸ì¢…</option><option>ê²½ê¸°</option><option>ê°•ì›</option><option>ì¶©ë¶</option><option>ì¶©ë‚¨</option><option>ì „ë¶</option><option>ì „ë‚¨</option><option>ê²½ë¶</option><option>ê²½ë‚¨</option><option>ì œì£¼</option><option>í•´ì™¸</option><option>ëª¨ë¦„</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">ì „í™”ë²ˆí˜¸</label>
                    <input type="tel" id="phone" class="input-field" placeholder="010-XXXX-XXXX">
                    <p class="text-xs text-gray-500 mt-1">(í•„ìˆ˜ì•„ë‹˜. ê¸°ì¬í•˜ì‹œë©´, ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë§¤ì¼ ìš´ì„¸ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤)</p>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-300 mb-1">ì´ë©”ì¼</label>
                    <input type="email" id="email" class="input-field" placeholder="you@example.com">
                    <p class="text-xs text-gray-500 mt-1">(í•„ìˆ˜ì•„ë‹˜, ê¸°ì¬í•˜ì‹œë©´ êµ¬ê¸€ìº˜ë¦°ë”ì™€ ì—°ë™í•˜ì—¬ ê·¸ë‚ ì˜ ì£¼ì˜ì‚¬í•­ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤)</p>
                </div>
            </div>
        </div>
        
        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="text-center mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
            <label for="contentLoader" class="custom-btn btn-secondary order-1 sm:order-1">ì‚¬ì§„ ì„ íƒ</label>
            <input type="file" id="contentLoader" accept="image/*"/>
            <button id="generateBtn" class="custom-btn btn-primary order-2 sm:order-2" disabled>ê´€ìƒ ë³´ê¸°(í´ë¦­)</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="w-full aspect-square bg-gray-700 rounded-lg flex items-center justify-center image-container">
                <img id="contentImage" src="" class="max-w-full max-h-full object-contain hidden rounded-md" alt="ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì–¼êµ´ ì´ë¯¸ì§€">
                <p id="contentPlaceholder" class="text-gray-500 text-center">ì–¼êµ´ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”. ê´€ìƒë§Œ ë³´ê³  ë°”ë¡œ ì‚­ì œí•˜ë‹ˆ ê±±ì •ë§ˆì„¸ìš”. </p>
            </div>
            <div id="resultContainer" class="w-full aspect-square bg-gray-700 rounded-lg flex items-center justify-center relative">
                <div id="loader" class="loader-container hidden">
                    <div class="loader"></div>
                    <p id="statusText" class="text-white mt-4 font-medium">ê´€ìƒê°€ ë¶„ì„ ë° ìƒì„± ì¤‘...</p>
                </div>
                <img id="generatedImage" src="" alt="AIê°€ ìƒì„±í•œ ì´ë¯¸ì§€" class="max-w-full max-h-full object-contain hidden rounded-md">
                <p id="resultPlaceholder" class="text-gray-500 text-center p-4">ê´€ìƒê°€ê°€ ê·¸ë¦° ê·¸ë¦¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
        
        <!-- ìš´ì„¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div id="fortune-results" class="mt-8 space-y-6 hidden">
            <h2 class="text-2xl font-bold text-center text-white">ìš´ì„¸ ë¶„ì„ ê²°ê³¼</h2>
            <div>
                <h3 class="text-xl font-semibold text-indigo-400 mb-2">ê´€ìƒ(ìƒì„±ê·¸ë¦¼ì´ ì•„ë‹Œ ì‹¤ì œ ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„)</h3>
                <div id="gwansang-result" class="result-box space-y-2">ë¶„ì„ ì¤‘...</div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-indigo-400 mb-2">ì‚¬ì£¼í’€ì´ ë° ì˜¬í•´ì˜ ìš´ì„¸</h3>
                <div id="saju-result" class="result-box space-y-2">ë¶„ì„ ì¤‘...</div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-indigo-400 mb-2">ì˜¤ëŠ˜ì˜ ìš´ì„¸</h3>
                <div id="today-fortune-result" class="result-box space-y-2">ë¶„ì„ ì¤‘...</div>
            </div>
        </div>
        
        <div class="text-center mt-4">
             <h3 class="text-lg font-semibold mb-2">ì°¸ê³  ê·¸ë¦¼ì²´</h3>
             <img src="https://lh3.googleusercontent.com/d/1V0lFIG8WZ5qpCaRN7qzsYoJnl9kzypk0" alt="ì°¸ê³  ê·¸ë¦¼ì²´" class="max-w-12 mx-auto rounded-lg shadow-lg">
        </div>
    </div>
    
<script>
  // NOTE: This Firebase config should be replaced with your own project's configuration.
  const __firebase_config = JSON.stringify({
    apiKey: "AIzaSyDeFrVH3y18empMfD0j84gzMz3uJXrm_0c",
    authDomain: "defenddestiny-11e12.firebaseapp.com",
    projectId: "defenddestiny-11e12",
    storageBucket: "defenddestiny-11e12.appspot.com",
    messagingSenderId: "425775598353",
    appId: "1:425775598353:web:aacab1f6dde1de1749ab0",
    measurementId: "G-Y2PW7NNWM2"
  });

  const __app_id = "defenddestiny-11e12";
</script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, runTransaction, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;

        const elements = {
            contentLoader: document.getElementById('contentLoader'),
            generateBtn: document.getElementById('generateBtn'),
            contentImage: document.getElementById('contentImage'),
            generatedImage: document.getElementById('generatedImage'),
            contentPlaceholder: document.getElementById('contentPlaceholder'),
            resultPlaceholder: document.getElementById('resultPlaceholder'),
            loader: document.getElementById('loader'),
            statusText: document.getElementById('statusText'),
            fortuneResults: document.getElementById('fortune-results'),
            gwansangResult: document.getElementById('gwansang-result'),
            sajuResult: document.getElementById('saju-result'),
            todayFortuneResult: document.getElementById('today-fortune-result'),
            visitorCount: document.getElementById('visitor-count')
        };

        let contentBase64 = null;
        let contentMimeType = '';
        
        async function initializeFirebaseAndCounter() {
            const visitorCountSpan = document.getElementById('visitor-count');
            if (typeof __firebase_config === 'undefined' || !__firebase_config || __firebase_config === "{}") {
                console.warn("Firebase config not found. Visitor counter is disabled.");
                visitorCountSpan.textContent = 'ì¹´ìš´íŠ¸ ë¹„í™œì„±';
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                const counterRef = doc(db, 'artifacts', appId, 'public/data/visitorCounter', 'countDoc');

                if (!sessionStorage.getItem('visitorCounted')) {
                    await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const newCount = (counterDoc.exists() ? counterDoc.data().value : 0) + 1;
                        transaction.set(counterRef, { value: newCount }, { merge: true });
                    });
                    sessionStorage.setItem('visitorCounted', 'true');
                }
                
                onSnapshot(counterRef, (doc) => {
                    visitorCountSpan.textContent = doc.exists() ? doc.data().value.toLocaleString() : '1';
                });

            } catch(error) {
                console.error("Firebase/Counter Initialization Error:", error);
                visitorCountSpan.textContent = "Error";
            }
        }
        
        initializeFirebaseAndCounter();
        
        function generateUUID() { 
            let d = new Date().getTime();
            let d2 = (performance && performance.now && (performance.now() * 1000)) || 0;
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                let r = Math.random() * 16;
                if (d > 0) {
                    r = (d + r) % 16 | 0;
                    d = Math.floor(d / 16);
                } else {
                    r = (d2 + r) % 16 | 0;
                    d2 = Math.floor(d2 / 16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
        
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) throw new Error('IP-API response not OK.');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Could not get user IP:', error);
                return 'N/A';
            }
        }
        
        function resizeImage(base64Str, maxSize = 512) {
            return new Promise((resolve) => {
                if (!base64Str) {
                    resolve(null);
                    return;
                }
                const img = new Image();
                img.src = `data:image/png;base64,${base64Str}`;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                 img.onerror = () => {
                    console.error("Image could not be loaded for resizing.");
                    resolve(null);
                };
            });
        }

        elements.contentLoader.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    elements.contentImage.src = event.target.result;
                    elements.contentImage.classList.remove('hidden');
                    elements.contentPlaceholder.classList.add('hidden');
                    contentBase64 = event.target.result.split(',')[1];
                    contentMimeType = file.type;
                    elements.generateBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        elements.generateBtn.addEventListener('click', async () => {
            if (!contentBase64) {
                console.error("ì½˜í…ì¸  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            elements.loader.classList.remove('hidden');
            elements.statusText.textContent = 'ë¶„ì„ ë° ê²°ê³¼ ì €ì¥ ì¤‘...';
            elements.generatedImage.classList.add('hidden');
            elements.resultPlaceholder.classList.remove('hidden');
            elements.resultPlaceholder.textContent = 'ê·¸ë¦¼ ìƒì„± ì¤‘...'
            elements.fortuneResults.classList.remove('hidden');
            elements.gwansangResult.innerHTML = 'ê´€ìƒ ë¶„ì„ ì¤‘...';
            elements.sajuResult.innerHTML = 'ì‚¬ì£¼í’€ì´ ë¶„ì„ ì¤‘...';
            elements.todayFortuneResult.innerHTML = 'ì˜¤ëŠ˜ì˜ ìš´ì„¸ ë¶„ì„ ì¤‘...';
            
            const userData = {
                birthdate: document.getElementById('birthdate').value,
                calendarType: document.querySelector('input[name="calendarType"]:checked')?.value || 'solar',
                birthtime: document.getElementById('birthtime').value,
                gender: document.querySelector('input[name="gender"]:checked')?.value || 'Not specified',
                birthRegion: document.getElementById('birthRegion').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
            };
            
            if (userData.phone || userData.email) {
                saveUserDataToSheet(userData);
            }
            
            const resizedImage = await resizeImage(contentBase64);

const [ipResult, imageResult, sajuResult] = await Promise.allSettled([
    getUserIP(),
    getImageAnalysisAndDrawing(resizedImage, contentMimeType),
    getSajuAndTodayFortune(userData)
]);

            const userIp = ipResult.status === 'fulfilled' ? ipResult.value : 'N/A';
            let gwansangAnalysis = 'ë¶„ì„ ì˜¤ë¥˜';
            let sajuData = { saju: 'ë¶„ì„ ì˜¤ë¥˜', todayFortune: 'ë¶„ì„ ì˜¤ë¥˜' };
            let generatedImgBase64 = null;

            if (imageResult.status === 'fulfilled') {
                const { generatedImgBase64: imgBase64, gwansangAnalysis: analysis } = imageResult.value;
                generatedImgBase64 = imgBase64;
                gwansangAnalysis = analysis;
                elements.generatedImage.src = `data:image/png;base64,${generatedImgBase64}`;
                elements.generatedImage.classList.remove('hidden');
                elements.resultPlaceholder.classList.add('hidden');
                
                elements.gwansangResult.innerHTML = '';
                 if (gwansangAnalysis) {
                     gwansangAnalysis.split('\n').forEach(line => {
                         if (line.trim()) {
                             const p = document.createElement('p');
                             p.innerHTML = line.replace(/\*\*(.*?)\*\*:/g, '<strong class="text-indigo-300">$1:</strong>');
                             elements.gwansangResult.appendChild(p);
                         }
                     });
                 } else {
                     elements.gwansangResult.textContent = 'ê´€ìƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                 }
            } else {
                console.error("Image/Gwansang Error:", imageResult.reason);
                elements.resultPlaceholder.textContent = `ê·¸ë¦¼/ê´€ìƒ ì˜¤ë¥˜: ${imageResult.reason.message}`;
                elements.gwansangResult.textContent = `ê´€ìƒ ë¶„ì„ ì˜¤ë¥˜: ${imageResult.reason.message}`;
            }

            if (sajuResult.status === 'fulfilled') {
                sajuData = parseSajuText(sajuResult.value);
                
                const renderFormattedResult = (element, text, fallback) => {
                    element.innerHTML = '';
                    if (text && text.trim()) {
                        text.split('\n').forEach(line => {
                            if (line.trim()) {
                                const p = document.createElement('p');
                                p.innerHTML = line.replace(/\*\*(.*?)\*\*:/g, '<strong class="text-indigo-300">$1:</strong>');
                                element.appendChild(p);
                            }
                        });
                    } else {
                        element.textContent = fallback;
                    }
                };

                renderFormattedResult(elements.sajuResult, sajuData.saju, 'ì‚¬ì£¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                renderFormattedResult(elements.todayFortuneResult, sajuData.todayFortune, 'ì˜¤ëŠ˜ì˜ ìš´ì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            } else {
                console.error("Saju/Today's Fortune Error:", sajuResult.reason);
                elements.sajuResult.textContent = `ì‚¬ì£¼/ìš´ì„¸ ë¶„ì„ ì˜¤ë¥˜: ${sajuResult.reason.message}`;
                elements.todayFortuneResult.textContent = `ì˜¤ëŠ˜ì˜ ìš´ì„¸ ë¶„ì„ ì˜¤ë¥˜: ${sajuResult.reason.message}`;
            }

            elements.statusText.textContent = 'ì´ë¯¸ì§€ ìµœì í™” ë° ìµœì¢… ì €ì¥ ì¤‘...';
            
            const [resizedUserImg, resizedAIIcon] = await Promise.all([
                resizeImage(contentBase64),
                generatedImgBase64 ? resizeImage(generatedImgBase64) : Promise.resolve(null)
            ]);

            await saveResultsToFirestore({
                ...userData,
                userIp: userIp,
                gwansangResult: gwansangAnalysis,
                sajuResult: sajuData.saju,
                todayFortuneResult: sajuData.todayFortune,
                userImageBase64: resizedUserImg,
                generatedImageBase64: resizedAIIcon
            });

            elements.loader.classList.add('hidden');
        });
        
        async function saveResultsToFirestore(data) {
            if (!db) {
                console.error("Firestore is not initialized. Cannot save data.");
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let userId = sessionStorage.getItem('anonymousUserId');
                if (!userId) {
                    userId = generateUUID();
                    sessionStorage.setItem('anonymousUserId', userId);
                }
                const resultsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'fortuneResults');
                await addDoc(resultsCollectionRef, {
                    ...data,
                    createdAt: new Date().toISOString()
                });
                console.log("Fortune results saved to Firestore successfully.");
            } catch (error) {
                console.error("Error saving results to Firestore:", error);
            }
        }

        function parseSajuText(text) {
            const data = { saju: '', todayFortune: '' };
            if (!text) return data;

            const todayHeader = '### ì˜¤ëŠ˜ì˜ ìš´ì„¸';
            const sajuHeader = '### ì‚¬ì£¼í’€ì´';
            const todayHeaderAlt = '### ['; // Alternative header
            
            let splitIndex = text.indexOf(todayHeader);
            if (splitIndex === -1) {
                splitIndex = text.indexOf(todayHeaderAlt);
            }

            if (splitIndex !== -1) {
                data.saju = text.substring(0, splitIndex).replace(sajuHeader, '').trim();
                data.todayFortune = text.substring(splitIndex).replace(todayHeader, '').trim();
            } else {
                data.saju = text.replace(sajuHeader, '').trim();
                data.todayFortune = ''; // Explicitly empty
            }
            
            return data;
        }
        
async function getImageAnalysisAndDrawing(resizedBase64, mimeType) {
  const response = await fetch("http://defenddestiny.com/analyze-image", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      imageBase64: resizedBase64,
      mimeType: mimeType
    })
  });

  if (!response.ok) {
    throw new Error("ë°±ì—”ë“œ ë¶„ì„ ì‹¤íŒ¨");
  }

  const result = await response.json();
  return {
    generatedImgBase64: result.generatedImgBase64,
    gwansangAnalysis: result.gwansangAnalysis
  };
}

        
        async function saveUserDataToSheet(userData) {
            const googleAppScriptUrl = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE"; 
            if (googleAppScriptUrl === "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE") {
                 console.warn("Google Apps Script URL is not set. Data was not saved.");
                 return;
            }
            try {
                await fetch(googleAppScriptUrl, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Error saving data to Google Sheet:', error);
            }
        }

        async function getImageAnalysis() {
            const apiKey = "AIzaSyBbE8WtD3uXI2eYp-lrISHk5myuNBjGSao";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: `You are a forensic artist and a physiognomy expert. Your tasks are separated by markdown headers.

### Drawing Description
**This part must be in English.**
Act as a forensic artist creating a description for another artist to draw a hyper-realistic portrait. The description must be extremely detailed, objective, and factual, focusing on geometric shapes, angles, and specific features. It should be so precise that the resulting drawing is nearly identical to the photo, including hair, ears, and neck. Break down the person into these specific components:
- **Face Shape:** Describe the overall shape (e.g., oval, round, square), jawline angle, and chin shape (e.g., pointed, square, rounded).
- **Eyes:** Detail the shape (e.g., almond, round), distance between them, presence and type of epicanthic fold, eyelid details (e.g., monolid, double eyelid, hooded), angle (e.g., upturned, downturned), and eyelash characteristics.
- **Eyebrows:** Describe the shape (e.g., straight, arched), thickness, density, and distance from the eyes.
- **Nose:** Detail the bridge width, tip shape (e.g., button, aquiline), nostril size and flare, and the angle from the face.
- **Mouth:** Describe lip fullness ratio (top vs. bottom), the definition of the cupid's bow, and the angle of the mouth corners.
- **Ears:** Describe the size, shape, lobe type (e.g., attached, detached), and any visible piercings.
- **Hair:** Detail the hairstyle (e.g., short, long, parted on the left), texture (e.g., straight, wavy, curly), length, color, and hairline shape.
- **Neck:** Note the length, thickness, and visibility of any prominent features like the Adam's apple.
- **Key Features:** Note the exact location and shape of any moles, scars, freckles, or significant wrinkles on the face and neck.
- **Pose and Expression:** Describe the head tilt, direction of gaze, and the specific expression (e.g., neutral, slight smile with left corner raised).

### Gwansang Analysis
**This part must be in KOREAN.**
Based on the image, provide a traditional Korean physiognomy (Gwansang) analysis. Analyze each key facial feature (forehead, eyes, nose, mouth, ears, chin, etc.) and explain their meanings in the context of fortune, personality, and life path. List each feature on a new line with the format "**ë¶€ìœ„ëª…**: ë¶„ì„ ë‚´ìš©".` },
                        { inlineData: { mimeType: contentMimeType, data: contentBase64 } }
                    ]
                }],
            };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: { message: response.statusText } }));
                throw new Error(`ì´ë¯¸ì§€ ë¶„ì„ API ì˜¤ë¥˜: ${err.error.message}`);
            }
            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            const drawingMatch = text.match(/### Drawing Description\s*([\s\S]*?)(?=\n###|$)/);
            const gwansangMatch = text.match(/### Gwansang Analysis\s*([\s\S]*)/);

            return {
                drawingDescription: drawingMatch ? drawingMatch[1].trim() : '',
                gwansangAnalysis: gwansangMatch ? gwansangMatch[1].trim() : ''
            };
        }
        
        async function getSajuAndTodayFortune(userData) {
            const apiKey = "AIzaSyBbE8WtD3uXI2eYp-lrISHk5myuNBjGSao";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const today = new Date();
            const year = today.getFullYear();
            const todayString = today.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
            });
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: `You are an expert in traditional Korean fortune telling. It is crucial to use the provided user information for the analysis.
                            
Please format your response clearly in KOREAN with markdown headers.

### ì‚¬ì£¼í’€ì´
First, on a new line, state the user's information clearly like this: "**ìƒë…„ì›”ì¼**: ${userData.birthdate} (${userData.calendarType}) / **ì‹œê°„**: ${userData.birthtime} / **ì„±ë³„**: ${userData.gender} / **ì§€ì—­**: ${userData.birthRegion}".
Then, analyze the user's information and provide a one-line summary for each of the following categories, using the format "**Category Name**: Summary". The categories are: **ì´ìš´ (Overall Fortune), ì¬ë¬¼ìš´ (Wealth Fortune), ì§ì—…ìš´ (Career Fortune), ì• ì •ìš´ (Love Fortune), ê±´ê°•ìš´ (Health Fortune)**. Finally, add a one-line summary for the current year, ${year}, with the title "**${year}ë…„ ì´ìš´:**".

### ì˜¤ëŠ˜ì˜ ìš´ì„¸
This section MUST start with the "### ì˜¤ëŠ˜ì˜ ìš´ì„¸" header on its own line.
On the next line, start with a title like this: "**[${todayString}]**".
Then, provide a concise horoscope for today. At the end, you **MUST** add a new section starting with a newline and the title "**ì˜¤ëŠ˜ì˜ í–‰ìš´**". Under it, list the following in the format "**Item**: Value1, Value2". You MUST provide two for each category: **í–‰ìš´ì˜ ìƒ‰ê¹” (Lucky Color), í–‰ìš´ì˜ ìˆ«ì (Lucky Number), í–‰ìš´ì˜ ì•„ì´í…œ (Lucky Item)**.`
                    },
                    ]
                }]
            };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: { message: response.statusText } }));
                throw new Error(`ì‚¬ì£¼/ìš´ì„¸ ë¶„ì„ API ì˜¤ë¥˜: ${err.error.message}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content.parts[0].text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("ì‚¬ì£¼/ìš´ì„¸ ë¶„ì„ APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function generateImageFromPrompt(prompt) {
            const apiKey = "AIzaSyBbE8WtD3uXI2eYp-lrISHk5myuNBjGSao";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: { message: response.statusText } }));
                throw new Error(`ê·¸ë¦¼ ìƒì„± API ì˜¤ë¥˜: ${err.error.message}`);
            }
            const result = await response.json();
            if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                return result.predictions[0].bytesBase64Encoded;
            } else {
                throw new Error("AIê°€ ê·¸ë¦¼ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }
    </script>
</body>
</html>
